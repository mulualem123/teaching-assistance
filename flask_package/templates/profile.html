{% extends 'base.html' %}

{% block title %}Profile - Saved Filters{% endblock %}

{% block content %}
<div class="container py-5">
  <h3>Profile</h3>
  <p class="text-muted">Manage your saved search filters.</p>

  <div class="mb-4">
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#savedFiltersListModal">View Saved Filters</button>
  </div>

  <div id="savedFiltersApp">
    <div class="card">
      <div class="card-body">
        <h5>Your saved filters</h5>
        <div id="savedFiltersList" class="mt-3">
          <div class="text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadProfileSavedFilters() {
    const container = document.getElementById('savedFiltersList');
    container.innerHTML = '<div class="text-muted">Loading...</div>';
    try {
        const res = await fetch('/api/saved_filters');
        if (!res.ok) throw new Error('Failed');
        const items = await res.json();
        if (!items || items.length === 0) {
            container.innerHTML = '<div class="text-muted">You have no saved filters.</div>';
            return;
        }
        container.innerHTML = items.map(s => `
            <div class="d-flex align-items-start justify-content-between py-2 border-bottom">
                <div>
                    <strong>${s.name}</strong>
                    <div class="small text-muted">${s.created_at ? new Date(s.created_at).toLocaleString() : ''}</div>
                    <div class="small text-muted mt-1">${(s.query && s.query.q) ? 'Search: "'+ s.query.q+'"' : ''} ${s.query && s.query.tags && s.query.tags.length ? ' â€¢ Tags: '+ s.query.tags.join(', ') : ''}</div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="applySavedFilter(${s.id})">Apply</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedFilter(${s.id})">Delete</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="togglePublic(${s.id}, ${s.query && s.query.is_public ? 'true' : 'false'})">Make public</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = '<div class="text-danger">Failed to load saved filters.</div>';
    }
}

async function applySavedFilter(id) {
    try {
        const res = await fetch('/api/saved_filters');
        const items = await res.json();
        const item = items.find(it => it.id === id);
        if (!item) return alert('Not found');
        const payload = (typeof item.query === 'string') ? JSON.parse(item.query) : item.query || {};
        // apply to global filterState and rerun
        window.filterState = window.filterState || {};
        filterState.q = payload.q || '';
        filterState.tags = payload.tags || [];
        filterState.op = payload.op || 'or';
        // push filters
        applyStateToUI();
        pushFiltersToURL();
        filterMezmurs();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
        console.error(e);
        alert('Failed to apply');
    }
}

async function deleteSavedFilter(id) {
    if (!confirm('Delete saved filter?')) return;
    try {
        const res = await fetch(`/api/saved_filters/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed');
        loadProfileSavedFilters();
    } catch (e) {
        console.error(e); alert('Failed to delete');
    }
}

async function togglePublic(id, current) {
    try {
        const res = await fetch(`/api/saved_filters/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_public: !current })
        });
        if (!res.ok) throw new Error('Failed');
        loadProfileSavedFilters();
    } catch (e) { console.error(e); alert('Failed to update saved filter'); }
}

// init
window.addEventListener('DOMContentLoaded', () => loadProfileSavedFilters());
</script>
{% endblock %}