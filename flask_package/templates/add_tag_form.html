<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tags - Zimare Yared</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stylesheet.css') }}">
</head>
<body class="bg-light">
    {% include 'navbar.html' %}

    <div class="container py-5">
        <div class="d-flex align-items-center mb-4">
            <a href="{{ url_for('mezmur') }}" class="btn btn-outline-secondary me-3"><i class="bi bi-arrow-left"></i></a>
            <h2 class="mb-0"><i class="bi bi-tags-fill me-2"></i>Manage Tags</h2>
        </div>

        <div class="row g-5">
            <!-- Add New Tag Section -->
            <div class="col-lg-5">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add a New Tag</h5>
                    </div>
                    <div class="card-body">
                        <form id="addTagPageForm" method="POST" action="/add_tag">
                            <div class="mb-3">
                                <label for="tagNameInput" class="form-label">Tag Name</label>
                                <input type="text" name="tag_name" class="form-control" id="tagNameInput" placeholder="e.g., Lent, Easter" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                Add Tag
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Existing Tags Section -->
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Existing Tags</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" id="existingTagsList">
                            {% if tags %}
                                {% for tag in tags %}
                                <li class="list-group-item d-flex justify-content-between align-items-center" data-tag-id="{{ tag.t_id }}">
                                    <span class="tag-name">{{ tag.tag }}</span>
                                    <div class="tag-actions">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="editTag(this, {{ tag.t_id }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTag({{ tag.t_id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </li>
                                {% endfor %}
                            {% else %}
                                <li class="list-group-item text-muted text-center">No tags found.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/mezmur.js') }}" defer></script>
    <script>
        // This script is specific to the add_tag_form page
        document.addEventListener('DOMContentLoaded', () => {
            const addTagForm = document.getElementById('addTagPageForm');
            if (addTagForm) {
                addTagForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(event.target);
                    const tagName = formData.get('tag_name').trim();

                    if (!tagName) {
                        showToast('Tag name cannot be empty.', 'warning');
                        return;
                    }

                    try {
                        const response = await fetch('/add_tag', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || 'Failed to add tag');
                        }

                        showToast(result.message, 'success');
                        event.target.reset();
                        // Dynamically add the new tag to the list
                        const newList = document.getElementById('existingTagsList');
                        const newTagItem = document.createElement('li');
                        newTagItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        newTagItem.dataset.tagId = result.tag_id; // Assumes backend returns new tag_id
                        newTagItem.innerHTML = `
                            <span class="tag-name">${result.tag}</span>
                            <div class="tag-actions">
                                <button class="btn btn-sm btn-outline-secondary" onclick="editTag(this, ${result.tag_id})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTag(${result.tag_id})"><i class="bi bi-trash"></i></button>
                            </div>
                        `;
                        // Remove the "No tags found" message if it exists
                        const noTagsMsg = newList.querySelector('.text-muted');
                        if (noTagsMsg) noTagsMsg.remove();
                        
                        newList.appendChild(newTagItem);

                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                    }
                });
            }
        });

        async function deleteTag(tagId) {
            if (!confirm('Are you sure you want to delete this tag? This cannot be undone.')) return;

            try {
                const response = await fetch(`/delete_tag/${tagId}`, { method: 'POST' }); // Changed to POST
                const result = await response.json();

                if (!response.ok) throw new Error(result.error || 'Failed to delete tag');

                showToast(result.message, 'success');
                document.querySelector(`[data-tag-id='${tagId}']`).remove();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // The editTag, saveTag, and cancelEdit functions are not directly used by the current backend
        // but are kept here for potential future implementation of in-place editing.
        function editTag(button, tagId) { /* ... (same as before) ... */ }
        async function saveTag(tagId, button) { /* ... (same as before) ... */ }
        function cancelEdit(button, tagId, name) { /* ... (same as before) ... */ }
    </script>
</body>
</html>